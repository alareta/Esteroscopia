<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
  <style>
    body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #fff; overflow: hidden; }
    canvas { max-width: 100%; max-height: 100%; object-fit: contain; image-rendering: pixelated; }
  </style>
</head>
<body>
<script>
/**
 * Estereoscopia 3D - Versión de Imagen Única (Sin Selector)
 * Versión: FINAL OPTIMIZADA (Lerp + Rescaling + Sleep Mode)
 */
/**
 * Prueba de Esteroscopia 3D con Selector de Escenas
 * Versión: FINAL OPTIMIZADA (Lerp + Rescaling + Sleep Mode)
 * Autor: alareta
 * Licencia: MIT
 */

let img, depthMap, view, zBuffer;
const MAX_DISPARITY = 18; 
let lastMouseX = 0;
let mouseInteractionTimer = 0;

// --- CONFIGURACIÓN DE RENDIMIENTO ---
const W = 800;   // Ancho del canvas
const H = 800;   // Alto del canvas
const RES = 0.7; // Resolución interna (0.7 = 70% para ganar velocidad)

let internalW = W * RES;
let internalH = H * RES;
let currentT = 0;

// --- CONFIGURACIÓN DE IMAGEN ---
// Cambia estas URLs por las de la imagen que quieras mostrar
const URL_IMAGEN = "https://raw.githubusercontent.com/alareta/Estereoscopia/refs/heads/main/imagenes/6_imagen.jpg";
const URL_PROFUNDIDAD = "https://raw.githubusercontent.com/alareta/Estereoscopia/refs/heads/main/imagenes/6_profundidad.png";

function preload() {
  img = loadImage(URL_IMAGEN, procesarImagen);
  depthMap = loadImage(URL_PROFUNDIDAD, procesarImagen);
}

function setup() {
  createCanvas(W, H);
  inicializarBuffers();
  lastMouseX = mouseX;
}

function procesarImagen() {
  if (img.width > 0 && depthMap.width > 0) {
    img.resize(internalW, internalH); 
    depthMap.resize(internalW, internalH);
    img.loadPixels();
    depthMap.loadPixels();
  }
}

function inicializarBuffers() {
  view = createImage(internalW, internalH);
  zBuffer = new Float32Array(internalW * internalH);
}

function draw() {
  // 1. SEGURIDAD: Verificar carga
  if (!img || !depthMap || !img.pixels || !depthMap.pixels || img.pixels.length === 0) {
    background(0);
    return;
  }

  // 2. CALCULAR OBJETIVO
  let targetT = 0;
  if (abs(mouseX - lastMouseX) > 0.1) {
    mouseInteractionTimer = 40; 
  }
  
  if (mouseInteractionTimer > 0) {
    targetT = map(mouseX, 0, width, -1, 1, true);
    mouseInteractionTimer--;
  } else {
    targetT = sin(frameCount * 0.05); 
  }
  lastMouseX = mouseX;

  // 3. OPTIMIZACIÓN DE REPOSO (Sleep Mode)
  let diff = abs(targetT - currentT);
  if (diff < 0.0005) {
      return; 
  }

  // 4. RENDERIZADO
  background(0); 
  currentT = lerp(currentT, targetT, 0.1);
  generateView(currentT, MAX_DISPARITY);
  
  image(view, 0, 0, width, height);
}

function generateView(t, maxDisparity) {
  view.loadPixels();
  zBuffer.fill(-1);

  for (let y = 0; y < internalH; y++) {
    for (let x = 0; x < internalW; x++) {
      let idx = x + y * internalW; 
      let p = idx * 4; 

      if (p >= depthMap.pixels.length) continue;

      let d = depthMap.pixels[p] / 255;
      d = 1.0 - d; 
      d = pow(d, 1.2); 

      let shift = int((d - 0.5) * maxDisparity * t);
      let tx = x + shift;

      if (tx >= 0 && tx < internalW) { 
        let tidx = tx + y * internalW; 
        if (d > zBuffer[tidx]) {
          let tp = tidx * 4;
          view.pixels[tp]     = img.pixels[p];
          view.pixels[tp + 1] = img.pixels[p + 1];
          view.pixels[tp + 2] = img.pixels[p + 2];
          view.pixels[tp + 3] = 255;
          zBuffer[tidx] = d;
        }
      }
    }
  }
  view.updatePixels();
}

function keyPressed() {
  if (key === "s" || key === "S") saveCanvas("render_estereoscopia", "png");
}
</script>
</body>
</html>